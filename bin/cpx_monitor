#!/usr/bin/python
from asyncio.log import logger
import os
import sys

import argparse
import cpx_monitor
from cpx_monitor.log import get_logger
from cpx_monitor.monitor import CpxMonitor
logger = get_logger("cpx_monitor")


def main():
    global cpx_monitor
    logger.info(
        "Welcome to CPX Monitoring Tool - {}".format(cpx_monitor.__version__))
    parser = argparse.ArgumentParser(
        description="A simple cpx server monitoring tool.")
    parser.add_argument("base_url", nargs='?',
                        help="URL for the CPX Monitoring service",
                        default="http://localhost:5500")
    parser.add_argument("--avg_per_service", required=False,
                        help="List services by type with theri average cpu/mem usage.",
                        action="store_true")

    args = parser.parse_args(sys.argv[1:])
    cpx_monitor = CpxMonitor(args.base_url)
    cpx_monitor.fetch_services()
    if args.avg_per_service:
        cpx_monitor.list_services_avg()
    else:
        cpx_monitor.list_services()


if __name__ == "__main__":
    main()
